<!doctype html>
<html>
<head>
    <title>joy.js</title>
    <style type="text/css">
        body {
            background: black;
            margin: 0;
        }

        #box {
            background: blue;
            height: 30px;
            left: 0;
            position: absolute;
            top: 0;
            width: 30px;
        }
    </style>
    <script type="text/javascript">
        const maxX = window.innerWidth - 30;
        const maxY = window.innerHeight - 30;
        const stepX = window.innerWidth / 70;
        const stepY = window.innerHeight / 70;
        const states = [];
        const listeners = {};

        window.addEventListener('gamepadconnected', e => {
            const j = e.gamepad;
            console.log('Gotta controller', j);
            connectGamepad(j);
        });

        function connectGamepad(j) {
            states[j.index] = {
                buttons: Array.from(j.buttons).fill(false),
                direction: {
                    up: false,
                    down: false,
                    left: false,
                    right: false
                }
            };
        }

        function checkButtons() {
            const gamepads = (Array.from(navigator.getGamepads()) || []).filter(g => !!g);
            if (gamepads && gamepads.length) {
                const j = gamepads.shift();
                if (!states[j.index]) {
                    connectGamepad(j);
                }
                const state = states[j.index];
                Array.from(j.buttons)
                    .forEach((b, i) => {
                        if (state.buttons[i] !== b.pressed) {
                            state.buttons[i] = b.pressed;
                            fireButtonEvent(i, b.pressed);
                        }
                    });
                const [x, y] = j.axes;
                y === -1 && fireButtonEvent('up', true);
                y === 1 && fireButtonEvent('down', true);
                x === -1 && fireButtonEvent('left', true);
                x === 1 && fireButtonEvent('right', true);
            }
            requestAnimationFrame(checkButtons);
        }

        function addButtonListener(button, callback) {
            if (!listeners[button]) {
                listeners[button] = [];
            }
            listeners[button].push(callback);
        }

        function fireButtonEvent(button, value) {
            const l = listeners[button] || [];
            l.forEach(cb => cb(value));
        }

        checkButtons();

        setTimeout(() => {
            const box = document.getElementById('box');
            let top = 0;
            let left = 0;
            addButtonListener('up', () => {
                if (top - stepY < 0) {
                   top = maxY;
                } else {
                    top -= stepY;
                }
                box.style.top = top + 'px';
            });
            addButtonListener('down', () => {
                if (top + stepY > maxY) {
                    top = 0;
                } else {
                    top += stepY;
                }
                box.style.top = top + 'px';
            });
            addButtonListener('left', () => {
                if (left - stepX < 0) {
                    left = maxX;
                } else {
                    left -= stepX;
                }
                box.style.left = left + 'px';
            });
            addButtonListener('right', () => {
                if (left + stepX > maxX) {
                    left = 0;
                } else {
                    left += stepX;
                }
                box.style.left = left + 'px';
            });
            addButtonListener('0', down => {
                if (down) {
                    box.style.background = 'blue';
                }
            });
            addButtonListener('1', down => {
                if (down) {
                    box.style.background = 'red';
                }
            });
            addButtonListener('2', down => {
                if (down) {
                    box.style.background = 'yellow';
                }
            });
            addButtonListener('3', down => {
                if (down) {
                    box.style.background = 'green';
                }
            });
        }, 100);
    </script>
</head>
<body>
    <div id="box"></div>
</body>
</html>
